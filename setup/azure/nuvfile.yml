# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

version: '3'

vars:
  D: ""
  RUN: '{{if eq .D ""}}{{else}}echo RUN:{{end}}'
  CAT: '{{if eq .D ""}}true{{else}}cat{{end}}'
  DATA: '{{if eq .D ""}}>_data_{{else}}echo DATA:{{end}}'
  _DATA: '{{if eq .D ""}}$(cat _data_){{else}}\$DATA{{end}}'
  TMP: '{{if eq .D ""}}$NUV_TMP{{else}}\$NUV_TMP{{end}}'

env:
  KUBECONFIG: |-
    if test -e $NUV_TMP/kubeconfig
    then echo $NUV_TMP/kubeconfig
    else echo ~/.kube/config
    fi

tasks:

  config:
    silent: true
    cmds:
    - "{{.RUN}} az aks get-credentials --name $AKS_NAME --resource-group $AKS_NAME --overwrite-existing -f {{.TMP}}/kubeconfig"

  prereq:
    silent: true
    cmds:
    - test -n "$AKS_NAME" || die 'Please, first configure AKS with "nuv setup config aks"'
    - "{{.RUN}} az version || die 'You need to install and configure az cli tool before running this command.'"

  create:
    silent: true
    desc: create aks cluster
    cmds:
    - task: prereq
    - "{{.DATA}} az account show --query 'id' -o tsv"
    - "{{.RUN}} az account set --subscription {{._DATA}}"
    - "{{.RUN}} az group create --name $AKS_NAME --location $AKS_REGION"
    - "{{.RUN}} az aks create -g $AKS_NAME -n $AKS_NAME --enable-managed-identity --node-count $AKS_COUNT --node-osdisk-size=$AKS_DISK --node-vm-size=$AKS_VM"
    - task: config

  delete:
    silent: true
    desc: delete aks cluster
    cmds:
    - echo "*** Deleting the $AKS_NAME cluster"
    - "{{.DATA}} az account show --query 'id' -o tsv"
    - "{{.RUN}} az account set --subscription {{._DATA}}"
    - "{{.RUN}} az aks delete --name $AKS_NAME --resource-group $AKS_NAME"
    - "{{.RUN}} rm {{.TMP}}/kubeconfig"
