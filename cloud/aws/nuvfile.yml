version: "3"

vars:
  RUN: '{{if eq .D ""}}{{else}}echo RUN:{{end}}'
  DIE: '{{if eq .D ""}}{{else}}die RUN:{{end}}'
  CAT: '{{if eq .D ""}}true{{else}}cat{{end}}'
  DATA: '{{if eq .D ""}}>_data_{{else}}echo DATA:{{end}}'
  _DATA: '{{if eq .D ""}}$(cat _data_){{else}}\$DATA{{end}}'
  TMP: '{{if eq .D ""}}$NUV_TMP{{else}}\$NUV_TMP{{end}}'
  SSH: "/usr/bin/ssh -oStrictHostKeyChecking=no"

tasks:
  prereq:
    silent: true
    cmds:
      - test -n "$AWS_SECRET_ACCESS_KEY" || die "please configure AWS with 'nuv config aws'"
      - aws --version >/dev/null || die 'You need to install and configure aws cli tool before running this command.'
      - >
        aws ec2 describe-key-pairs --key-names $AWS_SSHKEY --query 'KeyPairs[*].{KeyName: KeyName}' >/dev/null
        || die 'Please generate or import the configured key  before continuing.'
      - "{{.SSH}} -V || die 'you need an ssh client in your PATH'"
      - config AWS_PREREQ_OK="true"
    status:
    - config AWS_PREREQ_OK

  vm-list:
    silent: true
    cmds:
      - task: prereq
      - echo "*** List of created vms:"
      - > 
        aws ec2 describe-instances 
        --filters "Name=tag:Nuv,Values=true" 
        --query 'Reservations[].Instances[].[Tags[?Key==`NuvName`].Value | [0], Tags[?Key==`NuvType`].Value | [0], PublicIpAddress, State.Name]' 
        --output text
        | awk '{printf "%-15s %-10s %-15s %s\n", $1, $2, $3, $4}'

  vm-create:
    silent: true
    cmds:
      - task: prereq
      - |
        export NAME={{._name_}}
        if {{.__microk8s}}
        then envsubst -i microk8s.cf -o _vm-create.cf
        else envsubst -i ubuntu.cf -o _vm-create.cf
        fi
      - echo "*** Creating the VM."
      - >
        aws cloudformation create-stack 
        --stack-name nuv-{{._name_}} 
        --template-body file://_vm-create.cf 
        || true 
      - echo "*** Waiting until the VM is started..."
      - >
        aws cloudformation wait 
        stack-create-complete --stack-name nuv-{{._name_}}
      - task: vm-getip
      - >
        echo "*** Waiting until the VM is ready..." ;
        retry -t 1000 -m 1800 {{.SSH}} 
        "$AWS_VM_IMAGE_USER@$(cat _vm-ip)" 
        sudo cloud-init status --wait

  vm-getip:
    silent: true
    cmds:
    - |
      aws ec2 describe-instances --output json \
      --filters Name=tag:Nuv,Values=true Name=tag:NuvName,Values={{._name_}} Name=instance-state-name,Values=running \
      | jq -r '.Reservations[].Instances[].PublicIpAddress' >_vm-ip
      test -n "$(cat _vm-ip)" || die "Error: VM {{._name_}} not found"
    - cat _vm-ip

  vm-delete:
    cmds:
      - aws cloudformation delete-stack --stack-name nuv-{{._name_}}
      - aws cloudformation wait stack-delete-complete --stack-name nuv-{{._name_}}

  zone-create:
    silent: true
    cmds:
      - >
        aws route53 create-hosted-zone --name "{{._zone_}}" 
        --caller-reference "{{._zone_ |replace "." "-"}}" --output table
        || true
      - echo "Please delegate those name Servers for {{._zone_}}"
      - >
        aws route53 get-hosted-zone 
        --id "$(aws route53 list-hosted-zones --query "HostedZones[?Name=='{{._zone_}}.'].Id" --output text)"
        --query 'DelegationSet.NameServers' --output text

  zone-delete:
    silent: true
    cmds:
      - |
        ID=$(aws route53 list-hosted-zones --query "HostedZones[?Name=='{{._zone_}}.'].Id" --output text)
        aws route53 delete-hosted-zone --id "$ID" --output table

  zone-getid:
    silent: true
    cmds:
    - |
      if test -n "{{._zone_}}"
      then 
          aws route53 list-hosted-zones --output text \
          --query "HostedZones[?Name=='{{._zone_}}.'].Id" >_zone-id
          test -n "$(cat _zone-id)" || die "Error: zone {{._zone_}} not found"
      fi

  zone-list:
    silent: true
    cmds:
      - |
        if test -z "{{._zone_}}" 
        then aws route53  list-hosted-zones | jq -r '.HostedZones[] | [.Id, .Name] | @tsv' 
        else 
          ID=$(aws route53 list-hosted-zones --query "HostedZones[?Name=='{{._zone_}}.'].Id" --output text)
          aws route53 list-resource-record-sets --hosted-zone-id "$ID" --output table
        fi


  zone-update:
    silent: true
    cmds:
      - task: vm-getip
      - task: zone-getid
      - cmd: |
          export DOMAIN={{._zone_}}
          if test -n "{{.__vm}}"
          then export REC=A
               export VAL=$(cat _vm-ip)
          elif test -n "{{.__ip}}"
          then export REC=A
               export VAL="{{.__ip}}"
          elif test -n "{{.__cname}}"
          then export REC=CNAME
               export VAL="{{.__cname}}"
          fi
          if test -n "{{.__host}}"
          then export HOST="{{.__host}}"
          elif {{.__wildcard}}
          then export HOST="*"
          fi
          #echo :$DOMAIN
          #echo :$HOST
          #echo :$REC
          #echo :$VAL
          echo "Updating: $DOMAIN.$HOST $REC $VAL"
          envsubst -i upsert.json -o _upsert.json
      #- cat _upsert.json
      - >
        aws route53 change-resource-record-sets 
        --hosted-zone-id=$(cat _zone-id) 
        --change-batch file://_upsert.json

