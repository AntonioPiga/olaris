version: "3"

vars:
  RUN: '{{if eq .D ""}}{{else}}echo RUN:{{end}}'
  DIE: '{{if eq .D ""}}{{else}}die RUN:{{end}}'
  CAT: '{{if eq .D ""}}true{{else}}cat{{end}}'
  DATA: '{{if eq .D ""}}>_data_{{else}}echo DATA:{{end}}'
  _DATA: '{{if eq .D ""}}$(cat _data_){{else}}\$DATA{{end}}'
  TMP: '{{if eq .D ""}}$NUV_TMP{{else}}\$NUV_TMP{{end}}'

tasks:
  prereq:
    silent: true
    cmds:
      - test -n "$AWS_SECRET_ACCESS_KEY" || die "please configure AWS with 'nuv config aws'"
      - aws --version >/dev/null || die 'You need to install and configure aws cli tool before running this command.'
      - >
        aws ec2 describe-key-pairs --key-names $AWS_SSHKEY --query 'KeyPairs[*].{KeyName: KeyName}' >/dev/null
        || die 'Please generate or import the configured key  before continuing.'

  vm-list:
    silent: true
    cmds:
      - task: prereq
      - echo "*** List of created vms:"
      #- >
      #  aws ec2 describe-instances --output json 
      #  --query 'Reservations[*].Instances[*].[PublicIpAddress,State.Name,Tags[?Key==`Name`].Value]' 
      #  | jq -r '.[][] | "\(.[0]) \(.[1]) \(.[2][0])"'
      #  | awk '{ printf "%-20s%-10s%-15s\n", $1, $2, $3 }'
      - >
        aws ec2 describe-instances 
        --query 'Reservations[].Instances[].[PublicIpAddress, Tags[?Key==`Name`].Value | [0], State.Name, Tags[?Key==`nuv`].Value | [0]]' 
        --output json
        | jq -r '.[] | "\(.[0]) \(.[1]) \(.[2]) \(.[3])"'
        | awk '$4 != "null" { printf "%-16s%-20s%-15s\n", $1, $2, $3 }'

  vm-create:
    silent: true
    cmds:
      - task: prereq
      - |
        export NAME={{._name_}}
        if {{.__microk8s}}
        then envsubst -i mk8s.cf -o _vm-create.cf
        else envsubst -i plain.cf -o _vm-create.cf
        fi
      - echo "*** Waiting until the vm is ready..."
      - >
        aws cloudformation create-stack 
        --stack-name nuv-{{._name_}} 
        --template-body file://_vm-create.cf 
        || true 
      - >
        aws cloudformation wait 
        stack-create-complete --stack-name nuv-{{._name_}}
      - echo "Ready."

  vm-getip:
    silent: true
    cmds:
    - |
      if test -n "{{.__vm}}" ;
      then 
        aws ec2 describe-instances --output json \
        --filters Name=tag:Name,Values={{.__vm}} Name=instance-state-name,Values=running \
        | jq -r '.Reservations[].Instances[].PublicIpAddress' >_vm-ip
        test -n "$(cat _vm-ip)" || die "Error: VM {{.__vm}} not found"
      fi

  vm-delete:
    cmds:
      - aws cloudformation delete-stack --stack-name stack-{{._name_}}
      - aws cloudformation wait stack-delete-complete --stack-name stack-{{._name_}}

  zone-create:
    silent: true
    cmds:
      - >
        aws route53 create-hosted-zone --name "{{._zone_}}" 
        --caller-reference "{{._zone_ |replace "." "-"}}" --output table
        || true
      - echo "Please delegate those name Servers for {{._zone_}}"
      - >
        aws route53 get-hosted-zone 
        --id "$(aws route53 list-hosted-zones --query "HostedZones[?Name=='{{._zone_}}.'].Id" --output text)"
        --query 'DelegationSet.NameServers' --output text

  zone-delete:
    silent: true
    cmds:
      - |
        ID=$(aws route53 list-hosted-zones --query "HostedZones[?Name=='{{._zone_}}.'].Id" --output text)
        aws route53 delete-hosted-zone --id "$ID" --output table

  zone-getid:
    silent: true
    cmds:
    - |
      if test -n "{{._zone_}}"
      then 
          aws route53 list-hosted-zones --output text \
          --query "HostedZones[?Name=='{{._zone_}}.'].Id" >_zone-id
          test -n "$(cat _zone-id)" || die "Error: zone {{._zone_}} not found"
      fi

  zone-list:
    silent: true
    cmds:
      - |
        if test -z "{{._zone_}}" 
        then aws route53  list-hosted-zones | jq -r '.HostedZones[] | [.Id, .Name] | @tsv' 
        else 
          ID=$(aws route53 list-hosted-zones --query "HostedZones[?Name=='{{._zone_}}.'].Id" --output text)
          aws route53 list-resource-record-sets --hosted-zone-id "$ID" --output table
        fi


  zone-update:
    silent: true
    cmds:
      - task: vm-getip
      - task: zone-getid
      - cmd: |
          export DOMAIN={{._zone_}}
          if test -n "{{.__vm}}"
          then export REC=A
               export VAL=$(cat _vm-ip)
          elif test -n "{{.__ip}}"
          then export REC=A
              export VAL="{{.__ip}}"
          elif test -n "{{.__cname}}"
          then export REC=CNAME
              export VAL="{{.__cname}}"
          fi
          if test -n "{{.__host}}"
          then export HOST="{{.__host}}"
          elif {{.__wildcard}}
          then export HOST="*"
          fi
          #echo :$DOMAIN
          #echo :$HOST
          #echo :$REC
          #echo :$VAL
          echo "Updating: $DOMAIN.$HOST $REC $VAL"
          envsubst -i upsert.json -o _upsert.json
      #- cat _upsert.json
      - >
        aws route53 change-resource-record-sets 
        --hosted-zone-id=$(cat _zone-id) 
        --change-batch file://_upsert.json

