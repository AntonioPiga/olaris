version: '3'

dotenv:
  - /etc/environment

vars:
  BASEDIR: /tmp/nuvops
  HOSTNAME:
    sh: hostname

tasks:
 
  client:
    desc: client 

  server:
    silent: true
    desc: server
    cmds:
    - test "{{OS}}" == "linux" || die "sorry this is only for linux for now"
    - test -n "{{.HOSTNAME}}" || die "no hostname specified - use HOSTNAME="
    - test -n "$NUV_REMOTE_NTFY_TOPIC" || die "configure NUV_REMOTE_NTFY_TOPIC"
    - test -n "$NUV_REMOTE_NTFY_TOKEN" || die "configure NUV_REMOTE_NTFY_TOKEN"
    - mkdir -p "$NUV_TMP/nuvops"
    - echo "*** {{.HOSTNAME}} ***"
    - mkdir -p "{{.BASEDIR}}/{{.WORKDIR}}"
    - >
      ntfy sub
      --token "$NUV_REMOTE_NTFY_TOKEN"
      "$NUV_REMOTE_NTFY_TOPIC" 
      "nuv remote on_message"

  on_message:
    desc: react on messages using the first tag
    cmds:
    - task: on_{{.TAG}}
    vars:
      TAG:
        sh: echo "$NTFY_TAGS"

  on_upload:
    dir: "{{.BASEDIR}}/{{.HOSTNAME}}"
    silent: true
    cmds:
    - echo -n "[upload] files "
    - |
      URL="$(echo "$NTFY_RAW" | jq -r .attachment.url)"
      if curl -sL "$URL" -o _nuvops.tgz 
      then /usr/bin/tar xzvf _nuvops.tgz | wc -l
      else echo "ERROR!"
      fi

  on_command:
    silent: true
    dir: "{{.BASEDIR}}/{{.HOSTNAME}}"
    cmds:
    - |
      export NUV_PWD='{{.BASEDIR}}/{{.HOSTNAME}}'
      echo "[{{.HOSTNAME}}] $NTFY_TITLE "
      if [[ {{.HOSTNAME}} ==  $NTFY_TITLE ]]
      then 
           echo "$NTFY_TITLE matched {{.HOSTNAME}}"
           nuv ops $NTFY_MESSAGE
      else echo "!!! $NTFY_TITLE did NOT match {{.HOSTNAME}}"
      fi 
