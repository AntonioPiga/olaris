version: '3'

vars:
  BASEDIR: /tmp/nuvops
  HOSTNAME:
    sh: hostname

tasks:

  prereq:
    silent: true
    cmds:
    - test -n "$NUV_REMOTE_NTFY_TOPIC_IN" || die "configure NUV_REMOTE_NTFY_TOPIC_IN"
    - test -n "$NUV_REMOTE_NTFY_TOPIC_OUT" || die "configure NUV_REMOTE_NTFY_TOPIC_OUT"
    - test -n "$NUV_REMOTE_NTFY_TOKEN" || die "configure NUV_REMOTE_NTFY_TOKEN"
 
  run:
    silent: true
    desc: reply logger
    cmds:
    - task: prereq
    - echo "*** logger ***"
    - echo 0 >_curr
    - |
      export NTFY_TOKEN="$NUV_REMOTE_NTFY_TOKEN"
      ntfy sub "$NUV_REMOTE_NTFY_TOPIC_OUT" "nuv remote logger handle_message"

  handle_message:
    desc: react on messages using the firt tag
    silent: true
    cmds:
    #- echo "$NTFY_RAW" | jq .
    - task: on_{{.TAG}}
    vars:
      TAG:
        sh: echo "$NTFY_TAGS"
  
  on_JOIN:
    silent: true
    cmds:
    -  nuv remote client refresh
    -  echo "JOIN:" "$NTFY_TITLE"

  on_upload:
    silent: true

  on_UPLOAD:
    silent: true
    cmds:
    -  nuv remote client refresh >/dev/null
    -  echo "UPLOAD:" "$NTFY_TITLE $NTFY_MESSAGE"

  on_LOG:
    silent: true
    #desc: log one entry
    cmds:
    - |
      if ! test "$(cat _curr)" = "$NTFY_TIME"
      then echo "====================="
           echo "$NTFY_TIME" >_curr
      fi
    - echo "$NTFY_TITLE"
    - |
      URL="$(echo "$NTFY_RAW" | jq -r .attachment.url)"
      echo $URL
      if test "$URL" = "null"
      then echo "$NTFY_MESSAGE"
      else curl -sL "$URL"
      fi
  
  notify:
    silent: true
    dir: "{{.BASEDIR}}/{{.HOSTNAME}}"
    cmds: 
      - |
        export NTFY_TOPIC="$NUV_REMOTE_NTFY_TOPIC_OUT"
        export NTFY_TITLE="{{.HOSTNAME}}"
        export NTFY_MESSAGE="$(cat _msg)"
        export NTFY_TOKEN="$NUV_REMOTE_NTFY_TOKEN"
        cat _out \
        | ntfy publish --no-firebase \
        -p 1 --tags="$(cat _tag)" --file=- \
        | jq -r '"REPLY: "+ .attachment.url'
